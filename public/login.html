<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="./styles/login.css">
  <link rel="stylesheet" href="./styles/common.css">
  <title>Login</title>
</head>

<body>
  <div class="form-container">
      <h1 id="maintitle" class="mb-3">Iniciar sesión</h1>
      <form id="login" class="mb-3">
        <div class="mb-3 form-group">
          <label for="username" class="mb-1">Email</label>
          <input type="email" class="form-control" id="username" aria-describedby="emailHelp">
        </div>
        <div class="mb-3 form-group">
          <label for="password" class="mb-1">Contraseña</label>
          <input type="password" class="form-control" id="password">
        </div>
        <div class="d-flex justify-content-between mt-5">
          <button id="register" class="btn btn-primary loginButton">No tengo cuenta</button>
          <button id="submit" type="submit" class="btn btn-primary loginButton">Ingresar</button>

          <button id="comebackButton" class="btn btn-primary display-none">Ya tengo cuenta</button>
          <button id="createUserButton" type="submit" class="btn btn-primary display-none">
            Crear cuenta
          </button>
        </div>
      </form>
    </div>
  </div>
  <div class="alert alert-success display-none" id='alertInfo' role="alert"></div>
  <div class="alert alert-danger display-none" id='alertInfoError' role="alert"></div>
</body>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
  integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
  integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

<script>
  const rootIndex = '/index'
  const login = document.getElementById('login')
  const username = document.getElementById('username')
  const password = document.getElementById('password')
  const submitButton = document.getElementById('submit')
  const registerButton = document.getElementById('register')
  const createUserButton = document.getElementById('createUserButton')
  const comebackButton = document.getElementById('comebackButton')
  const title = document.getElementById('maintitle')
  const alertSuccess = document.getElementById('alertInfo')
  const alertError = document.getElementById('alertInfoError')

  const onSubmit = async loginOrCreateUser => {
    if (loginOrCreateUser === 'login') {
      const data = await fetch('/api/sessions/validateLogin', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username: username.value, password: password.value })
      })
      return await data.json()
    }

    if (loginOrCreateUser === 'createUser') {
      const register = await fetch('/api/sessions/createUser', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username: username.value, password: password.value })
      })
      return await register.json()
    }
  }

  const activeAlert = (text, alert) => {
    alert.innerHTML = text
    alert.classList.remove('display-none')
    setTimeout(() => alert.classList.add('display-none'), 4000)
  }

  login.addEventListener('submit', e => {
    e.preventDefault()
    username.value.length !== 0 && password.value.length !== 0 &&
      onSubmit('login')
        .then(() => window.location = rootIndex)
        .catch((err) => activeAlert('Email o contrasena incorrecto', alertError))
  })

  registerButton.addEventListener('click', e => {
    e.preventDefault()
    title.innerHTML = 'Crear usuario'
    registerButton.classList.add('display-none')
    submitButton.classList.add('display-none')
    createUserButton.classList.remove('display-none')
    comebackButton.classList.remove('display-none')
  })

  comebackButton.addEventListener('click', e => {
    title.innerHTML = 'Iniciar sesión'
    registerButton.classList.remove('display-none')
    submitButton.classList.remove('display-none')
    createUserButton.classList.add('display-none')
    comebackButton.classList.add('display-none')
  })

  createUserButton.addEventListener('click', e => {
    e.preventDefault()
    onSubmit('createUser')
      .then((res) => {
        if (res.data) {
          activeAlert('Usuario creado correctamente', alertSuccess)
          registerButton.classList.remove('display-none')
          registerButton.classList.remove('display-none')
          submitButton.classList.remove('display-none')
          createUserButton.classList.add('display-none')
        }
      })
      .catch(err => {
        if (password.value.length === 0 || username.value.length === 0) return activeAlert('Debes completar todos los datos', alertError)
        return activeAlert('Email existente!', alertError)
      })
  })
</script>

</html>